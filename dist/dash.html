<!doctype html>

<html>

  <head>

     <title>Dash.js Rocks</title>

  </head>

  <body>

     <div>

        <video id="videoPlayer" controls="true"></video>

     </div>

     <script src="dash.all.js"></script>
     <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>-->
     <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip"></script>-->
     <script>
        (function(){

           var url = "http://rdmedia.bbc.co.uk/dash/ondemand/testcard/1/client_manifest-events.mpd";

           var context = new Dash.di.DashContext();

           var player = new MediaPlayer(context);

           player.startup();

           player.attachView(document.querySelector("#videoPlayer"));

           /*
           var sendBitrate = function(myip) {
                  var jsonObj = {"ip": myip, "phy": {"w": screen.width, "h": screen.height}, "video": []};
                  var bitrateInfoList = player.getBitrateInfoListFor("video");
                  for (var i = 0; i < bitrateInfoList.length; i++) {
                    jsonObj["video"].push({"w": bitrateInfoList[i].width, "h": bitrateInfoList[i].height, "br": bitrateInfoList[i].bitrate});
                  }
                  player.sendToSocketServer(JSON.stringify(jsonObj));
                  setInterval(function(){player.sendToSocketServer("H" + myip);}, 3000);
           };
            window.RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;   //compatibility for firefox and chrome
            var pc = new RTCPeerConnection({iceServers:[]}), noop = function(){};      
            pc.createDataChannel("");    //create a bogus data channel
            pc.createOffer(pc.setLocalDescription.bind(pc), noop);    // create offer and set local description
            pc.onicecandidate = function(ice){  //listen for candidate events
                if(!ice || !ice.candidate || !ice.candidate.candidate)  return;
                var myip = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate)[1];
                if (!myip.match(/^(192\.168\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/)) return;
                pc.onicecandidate = noop;
                if (player.getBitrateInfoListFor("video") != null && player.getBitrateInfoListFor("video").length > 0) {
                  sendBitrate(myip + "-" + player.getId());
                } else {
                  player.addEventListener(MediaPlayer.events.STREAM_INITIALIZED, function(){
                    sendBitrate(myip + "-" + player.getId());
                  });
                }

            };
            */
            
           player.attachSource(url);

           /*
           setInterval(function(){
            ls = player.getMetricsFor("stream").HttpList;
            console.log("Length: " + ls.length);
            console.log(JSON.stringify(ls));
           }, 1000); */
           
        })();

     </script>

  </body>
</html>